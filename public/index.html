<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Chat with Supabase</title>
    <style>
        body { font-family: Arial, sans-serif; }
        #chat { border: 1px solid #ccc; padding: 10px; width: 300px; height: 400px; overflow-y: scroll; }
        #messageInput { width: 100%; }
        #stats { margin-top: 10px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.29.0/dist/umd/supabase.min.js"></script>
</head>
<body>
    <div id="chat"></div>
    <input id="messageInput" type="text" placeholder="Type a message...">
    <div id="stats">
        <p>Total connections: <span id="totalConnections">0</span></p>
    </div>

    <script>
        const SUPABASE_URL = 'your-supabase-url'; // Supabase URL
        const SUPABASE_KEY = 'your-supabase-key'; // Supabase anon key
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const chat = document.getElementById('chat');
        const messageInput = document.getElementById('messageInput');
        const totalConnections = document.getElementById('totalConnections');

        async function fetchMessages() {
            const { data, error } = await supabase
                .from('messages')
                .select('*')
                .order('inserted_at', { ascending: true });

            if (error) {
                console.error('Error fetching messages:', error);
            } else {
                data.forEach(displayMessage);
            }
        }

        function displayMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.textContent = `${message.username}: ${message.content}`;
            chat.appendChild(messageDiv);
        }

        supabase
            .from('messages')
            .on('INSERT', payload => {
                displayMessage(payload.new);
            })
            .subscribe();

        messageInput.addEventListener('keypress', async (event) => {
            if (event.key === 'Enter' && messageInput.value.trim() !== '') {
                const username = 'User'; // You can replace this with a dynamic username
                const content = messageInput.value;

                console.log(`Sending message: ${content}`); // Debugging message

                const { error } = await supabase
                    .from('messages')
                    .insert([{ username, content }]);

                if (error) {
                    console.error('Error inserting message:', error);
                } else {
                    messageInput.value = '';
                }
            }
        });

        fetchMessages();
    </script>
</body>
</html>
